[org 0x7E00]
[bits 16]
%include "out/buildinfo.inc"

COM1 equ 0x3F8

; --- serial ---------------------------------------------------
serial_init:
    mov dx, COM1+1
    xor al, al
    out dx, al
    mov dx, COM1+3
    mov al, 0x80
    out dx, al
    mov dx, COM1+0
    mov al, 0x01
    out dx, al
    mov dx, COM1+1
    xor al, al
    out dx, al
    mov dx, COM1+3
    mov al, 0x03
    out dx, al
    mov dx, COM1+2
    mov al, 0xC7
    out dx, al
    mov dx, COM1+4
    mov al, 0x0B
    out dx, al
    ret

serial_putc:
.wait:
    mov dx, COM1+5
    in  al, dx
    test al, 0x20
    jz  .wait
    mov dx, COM1
    out dx, al
    ret

serial_puts:             ; DS:SI -> asciz
.next:
    lodsb
    test al, al
    jz   .done
    call serial_putc
    jmp  .next
.done:
    ret

; --- VGA text -------------------------------------------------
vga_puts:                ; DS:SI -> asciz
    push ax
    push bx
    push cx
    push di
    push es
    mov  ax, 0xB800
    mov  es, ax
    xor  di, di
    mov  ah, 0x0F
.vloop:
    lodsb
    test al, al
    jz   .vok
    cmp  al, 10
    jne  .vwrite
    mov  bx, di
    mov  cx, 160
    xor  dx, dx
    mov  ax, bx
    div  cx
    inc  ax
    mul  cx
    mov  di, ax
    jmp  .vloop
.vwrite:
    stosw
    jmp  .vloop
.vok:
    pop  es
    pop  di
    pop  cx
    pop  bx
    pop  ax
    ret

; --- data -----------------------------------------------------
banner:
    db "SOVRN ENGINE ONLINE "
    db "PRODUCT=",     BI_PRODUCT_STR,     " "
    db "VERSION=",     BI_VERSION_STR,     " "
    db "COMMIT=",      BI_COMMIT_STR,      " "
    db "BUILD_EPOCH=", BI_BUILD_EPOCH_STR, " "
    db "TRIPLE=",      BI_TRIPLE_STR,      " "
    db "TOOLCHAIN=",   BI_TOOLCHAIN_STR,   13,10,0

; --- entry ----------------------------------------------------
start:
    ; **enter at 0000:7E00** (CS=0)
    xor ax, ax
    mov ds, ax
    mov ss, ax
    mov sp, 0x7C00

    call serial_init
    mov  si, banner
    call vga_puts
    mov  si, banner
    call serial_puts

.hang:
    hlt
    jmp .hang
